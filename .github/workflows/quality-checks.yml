name: Quality Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Run accessibility linting
        run: npm run lint:a11y

  test:
    name: Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:run
      
      - name: Run accessibility tests
        run: npm run test:a11y
      
      - name: Generate coverage report
        run: npm run test:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next
          retention-days: 7

  performance:
    name: Performance Checks
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build with analysis
        run: npm run build:analyze
        env:
          ANALYZE: true
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      
      - name: Run bundle analysis
        id: bundle-analysis
        run: node scripts/bundle-analysis-ci.js
        continue-on-error: true
      
      - name: Run TypeScript error monitoring
        id: typecheck
        run: npm run typecheck:monitor
        continue-on-error: true
      
      - name: Upload performance reports
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            bundle-stats.json
            .bundle-trends/
            .typescript-trends/
            docs/bundle-size-validation.md
            docs/typescript-errors.md
          retention-days: 30
      
      - name: Comment PR with performance summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ğŸš€ Performance Summary\n\n';
            
            // Bundle size report
            const bundleReportPath = 'docs/bundle-size-validation.md';
            if (fs.existsSync(bundleReportPath)) {
              const bundleReport = fs.readFileSync(bundleReportPath, 'utf8');
              comment += '### ğŸ“¦ Bundle Size Analysis\n\n';
              comment += bundleReport + '\n\n';
            }
            
            // TypeScript report
            const tsReportPath = 'docs/typescript-errors.md';
            if (fs.existsSync(tsReportPath)) {
              const tsReport = fs.readFileSync(tsReportPath, 'utf8');
              comment += '### ğŸ“ TypeScript Error Monitoring\n\n';
              // Truncate if too long
              const maxLength = 30000;
              const truncatedReport = tsReport.length > maxLength 
                ? tsReport.substring(0, maxLength) + '\n\n... (truncated, see artifacts for full report)'
                : tsReport;
              comment += truncatedReport + '\n\n';
            }
            
            // Add recommendations
            comment += '### ğŸ’¡ Recommendations\n\n';
            comment += '- Review bundle size changes before merging\n';
            comment += '- Ensure no new `any` types are introduced\n';
            comment += '- Check that all tests pass\n';
            comment += '- Verify accessibility compliance\n';
            
            // Truncate entire comment if needed
            const maxCommentLength = 65000;
            if (comment.length > maxCommentLength) {
              comment = comment.substring(0, maxCommentLength) + '\n\n... (truncated)';
            }
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Performance Summary')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
      
      - name: Check performance thresholds
        run: |
          BUNDLE_FAILED="${{ steps.bundle-analysis.outcome }}"
          TYPECHECK_FAILED="${{ steps.typecheck.outcome }}"
          
          if [ "$BUNDLE_FAILED" = "failure" ] || [ "$TYPECHECK_FAILED" = "failure" ]; then
            echo "âŒ Performance checks failed"
            echo "Bundle analysis: $BUNDLE_FAILED"
            echo "TypeScript check: $TYPECHECK_FAILED"
            exit 1
          fi
          
          echo "âœ… All performance checks passed"

  accessibility:
    name: Accessibility Audit
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run keyboard navigation tests
        run: npm run test:keyboard
      
      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      
      - name: Start server
        run: npm run start &
        env:
          PORT: 3000
      
      - name: Wait for server
        run: npx wait-on http://localhost:3000
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:3000
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Run dependency check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'what-to-wear'
          path: '.'
          format: 'HTML'
        continue-on-error: true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
          retention-days: 30

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build, performance, accessibility, security]
    if: always()
    
    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              lint: '${{ needs.lint.result }}',
              test: '${{ needs.test.result }}',
              build: '${{ needs.build.result }}',
              performance: '${{ needs.performance.result }}',
              accessibility: '${{ needs.accessibility.result }}',
              security: '${{ needs.security.result }}'
            };
            
            const passed = Object.values(results).filter(r => r === 'success').length;
            const total = Object.keys(results).length;
            
            let summary = '## ğŸ“Š Quality Check Summary\n\n';
            summary += `**${passed}/${total} checks passed**\n\n`;
            
            for (const [check, result] of Object.entries(results)) {
              const emoji = result === 'success' ? 'âœ…' : 'âŒ';
              summary += `${emoji} ${check}: ${result}\n`;
            }
            
            console.log(summary);
            
            if (passed < total) {
              core.setFailed('Some quality checks failed');
            }
